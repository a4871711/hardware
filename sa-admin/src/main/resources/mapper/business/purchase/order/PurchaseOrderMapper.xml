<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.business.purchase.order.dao.PurchaseOrderDao">

    <!-- 查询结果列 -->
    <sql id="base_columns">
        t_purchase_order.purchase_order_id,
        t_purchase_order.purchase_order_code,
        t_purchase_order.delivery_date,
        t_purchase_order.receive_date,
        t_purchase_order.cust_id,
        t_purchase_order.tax_type,
        t_purchase_order.tax_rate,
        t_purchase_order.receive_address,
        t_purchase_order.remark,
        t_purchase_order.company_id,
        t_purchase_order.version,
        t_purchase_order.create_user_id,
        t_purchase_order.create_user_name,
        t_purchase_order.create_time,
        t_purchase_order.update_user_id,
        t_purchase_order.update_user_name,
        t_purchase_order.update_time,
        t_purchase_order.deleted_flag,
        t_purchase_order.invalid
    </sql>

    <!-- 分页查询 -->
    <select id="queryPage" resultType="net.lab1024.sa.admin.module.business.purchase.order.domain.vo.PurchaseOrderVO">
        SELECT
        <include refid="base_columns"/>
        FROM t_purchase_order
    </select>

    <update id="batchUpdateDeleted">
        update t_purchase_order set deleted_flag = #{deletedFlag}
        where purchase_order_id in
        <foreach collection="idList" open="(" close=")" separator="," item="item">
            #{item}
        </foreach>
    </update>

    <update id="updateDeleted">
        update t_purchase_order
        set deleted_flag = #{deletedFlag}
        where purchase_order_id = #{purchaseOrderId}
    </update>


    <select id="isReferenced"
            resultType="net.lab1024.sa.admin.module.business.purchase.request.domain.vo.PurchaseOrderReferenceVO">
        SELECT
        <include refid="base_columns"/>,
        t_purchase_request_order.purchase_request_order_code,t_purchase_request_order.purchase_request_order_id
        FROM t_purchase_order t_purchase_order
        INNER JOIN t_purchase_order_detail t_purchase_order_detail
        ON t_purchase_order_detail.purchase_order_id = t_purchase_order.purchase_order_id
        INNER JOIN t_purchase_request_order_detail t_purchase_request_order_detail
        ON t_purchase_request_order_detail.purchase_request_order_detail_id =
        t_purchase_order_detail.purchase_request_order_detail_id
        INNER JOIN t_purchase_request_order t_purchase_request_order
        ON t_purchase_request_order.purchase_request_order_id =
        t_purchase_request_order_detail.purchase_request_order_id
        <where>
            t_purchase_order.deleted_flag = 0
            AND t_purchase_order.audit = 0
            <if test="purchaseRequestOrderDetailIds != null and purchaseRequestOrderDetailIds.size() > 0">
                AND t_purchase_request_order_detail.purchase_request_order_detail_id IN
                <foreach collection="purchaseRequestOrderDetailIds" item="item" separator="," open="(" close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
</mapper>
