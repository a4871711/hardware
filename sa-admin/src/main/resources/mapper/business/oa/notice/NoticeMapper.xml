<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="net.lab1024.sa.admin.module.business.oa.notice.dao.NoticeDao">

    <!-- ================================== 可见范围相关 ================================== -->

    <insert id="insertVisibleRange">
        insert into t_notice_visible_range
        (notice_id, data_type, data_id)
        values
        <foreach collection="visibleRangeFormList" separator="," item="item">
            ( #{noticeId} , #{item.dataType}, #{item.dataId} )
        </foreach>
    </insert>
    <delete id="deleteVisibleRange">
        delete
        from t_notice_visible_range
        where notice_id = #{noticeId}
    </delete>

    <select id="queryVisibleRange"
            resultType="net.lab1024.sa.admin.module.business.oa.notice.domain.vo.NoticeVisibleRangeVO">
        select *
        from t_notice_visible_range
        where notice_id = #{noticeId}
    </select>

    <!-- ================================== 通知公告【主表】相关 ================================== -->
    <update id="updateDeletedFlag">
        update t_notice
        set deleted_flag = true
        where notice_id = #{noticeId}
    </update>

    <!-- 后管分页查询资讯 -->
    <select id="query" resultType="net.lab1024.sa.admin.module.business.oa.notice.domain.vo.NoticeVO">
        SELECT
        n.*,
        nt.notice_type_name AS noticeTypeName,
        emp.actual_name AS createUserName,
        d.name AS departmentName
        FROM t_notice n
        LEFT JOIN t_notice_type nt
        ON nt.notice_type_id = n.notice_type_id
        LEFT JOIN t_employee emp
        ON n.create_user_id = emp.employee_id
        LEFT JOIN t_department d
        ON emp.department_id = d.department_id
        <where>
            <if test="query.noticeTypeId != null">
                AND nt.notice_type_id = #{query.noticeTypeId}
            </if>
            <if test="query.keywords != null and query.keywords !=''">
                AND ( INSTR(n.title, #{query.keywords})
                OR INSTR(n.author, #{query.keywords})
                OR INSTR(n.source, #{query.keywords})
                )
            </if>
            <if test="query.documentNumber != null and query.documentNumber !=''">
                AND INSTR(n.document_number, #{query.documentNumber})
            </if>
            <if test="query.createUserId != null">
                AND n.create_user_id = #{createUserId}
            </if>
            <if test="query.deletedFlag != null">
                AND n.deleted_flag = #{query.deletedFlag}
            </if>
            <if test="query.createTimeBegin != null">
                AND DATE_FORMAT(n.create_time, '%Y-%m-%d') >= DATE_FORMAT(#{query.createTimeBegin}, '%Y-%m-%d')
            </if>
            <if test="query.createTimeEnd != null">
                AND DATE_FORMAT(n.create_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{query.createTimeEnd}, '%Y-%m-%d')
            </if>
            <if test="query.publishTimeBegin != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') >= DATE_FORMAT(#{query.publishTimeBegin}, '%Y-%m-%d')
            </if>
            <if test="query.publishTimeEnd != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{query.publishTimeEnd}, '%Y-%m-%d')
            </if>
        </where>
        <if test="query.sortItemList == null or query.sortItemList.size == 0">
            ORDER BY n.publish_time DESC, n.notice_id DESC
        </if>
    </select>

    <!-- ================================== 通知公告【员工查看】相关 ================================== -->
    <select id="queryEmployeeNotice"
            resultType="net.lab1024.sa.admin.module.business.oa.notice.domain.vo.NoticeEmployeeVO">
        SELECT
        n.*,
        nt.notice_type_name AS noticeTypeName,
        (SELECT COUNT(*) FROM t_notice_view_record vr
        WHERE vr.employee_id = #{requestEmployeeId}
        AND vr.notice_id = n.notice_id) AS viewFlag
        FROM t_notice n
        LEFT JOIN t_notice_type nt
        ON n.notice_type_id = nt.notice_type_id
        <where>
            <if test="!administratorFlag">
                (
                n.notice_id IN
                (SELECT vr.notice_id
                FROM t_notice_visible_range vr
                WHERE
                ( vr.data_type = #{departmentDataType}
                <if test="requestEmployeeDepartmentIdList != null and requestEmployeeDepartmentIdList.size > 0">
                    AND vr.data_id IN
                    <foreach collection="requestEmployeeDepartmentIdList" open="(" close=")" separator="," item="item">
                        #{item}
                    </foreach>
                </if>
                )
                OR ( vr.data_type = #{employeeDataType} AND vr.data_id = #{requestEmployeeId} )
                )
                OR n.all_visible_flag = true
                )
            </if>
            AND n.deleted_flag = #{deletedFlag}
            AND n.publish_time &lt; NOW()
            <if test="query.noticeTypeId != null">
                AND nt.notice_type_id = #{query.noticeTypeId}
            </if>
            <if test="query.keywords != null and query.keywords !=''">
                AND ( INSTR(n.title, #{query.keywords})
                OR INSTR(n.author, #{query.keywords})
                OR INSTR(n.document_number, #{query.keywords})
                OR INSTR(n.source, #{query.keywords})
                )
            </if>
            <if test="query.publishTimeBegin != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') >= DATE_FORMAT(#{query.publishTimeBegin}, '%Y-%m-%d')
            </if>
            <if test="query.publishTimeEnd != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') &gt;= DATE_FORMAT(#{query.publishTimeEnd}, '%Y-%m-%d')
            </if>
            <if test="query.notViewFlag">
                AND viewFlag = 0
            </if>
        </where>
        ORDER BY n.publish_time DESC
    </select>
    <select id="queryEmployeeNotViewNotice"
            resultType="net.lab1024.sa.admin.module.business.oa.notice.domain.vo.NoticeEmployeeVO">
        SELECT * FROM
        (
        SELECT
        n.*,
        nt.notice_type_name AS noticeTypeName,
        (SELECT COUNT(*) FROM t_notice_view_record vr
        WHERE vr.employee_id = #{requestEmployeeId}
        AND vr.notice_id = n.notice_id) AS viewFlag
        FROM t_notice n
        LEFT JOIN t_notice_type nt
        ON n.notice_type_id = nt.notice_type_id
        <where>
            <if test="!administratorFlag">
                n.notice_id IN
                (SELECT vr.notice_id
                FROM t_notice_visible_range vr
                WHERE
                (vr.data_type = #{departmentDataType}
                <if test="requestEmployeeDepartmentIdList != null and requestEmployeeDepartmentIdList.size > 0">
                    AND vr.data_id IN
                    <foreach collection="requestEmployeeDepartmentIdList" open="(" close=")" separator="," item="item">
                        #{item}
                    </foreach>
                </if>
                )
                OR ( vr.data_type = #{employeeDataType} AND vr.data_id = #{requestEmployeeId} )
                )
            </if>
            AND n.all_visible_flag = true
            AND n.deleted_flag = #{deletedFlag}
            AND n.publish_time &lt; NOW()
            <if test="query.noticeTypeId != null">
                AND nt.notice_type_id = #{query.noticeTypeId}
            </if>
            <if test="query.keywords != null and query.keywords !=''">
                AND ( INSTR(n.title, #{query.keywords})
                OR INSTR(n.author, #{query.keywords})
                OR INSTR(n.documentNumber, #{query.keywords})
                OR INSTR(n.source, #{query.keywords})
                )
            </if>
            <if test="query.publishTimeBegin != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') >= DATE_FORMAT(#{query.publishTimeBegin}, '%Y-%m-%d')
            </if>
            <if test="query.publishTimeEnd != null">
                AND DATE_FORMAT(n.publish_time, '%Y-%m-%d') &lt;= DATE_FORMAT(#{query.publishTimeEnd}, '%Y-%m-%d')
            </if>
        </where>
        ) t WHERE viewFlag = 0
        ORDER BY t.publish_time DESC
    </select>
    <select id="queryNoticeViewRecordList"
            resultType="net.lab1024.sa.admin.module.business.oa.notice.domain.vo.NoticeViewRecordVO">
        SELECT
        vr.*,
        emp.actual_name AS employeeName,
        d.name AS departmentName
        FROM t_notice_view_record vr
        LEFT JOIN t_employee emp
        ON emp.employee_id = vr.employee_id
        LEFT JOIN t_department d
        ON d.department_id = emp.department_id
        WHERE vr.notice_id = #{queryForm.noticeId}
        <if test="queryForm.keywords != null and queryForm.keywords !=''">
            AND (
            INSTR(emp.actual_name, #{queryForm.keywords})
            OR INSTR(vr.first_ip, #{queryForm.keywords})
            OR INSTR(vr.first_user_agent, #{queryForm.keywords})
            OR INSTR(vr.last_ip, #{queryForm.keywords})
            OR INSTR(vr.last_user_agent, #{queryForm.keywords})
            )
        </if>
        <if test="queryForm.departmentId != null ">
            AND d.department_id = #{queryForm.departmentId}
        </if>
        ORDER BY vr.update_time DESC, vr.create_time DESC
    </select>

    <!-- ================================== 通知公告【员工查看记录】相关 ================================== -->
    <select id="viewRecordCount" resultType="java.lang.Long">
        select count(*)
        from t_notice_view_record
        where notice_id = #{noticeId}
          and employee_id = #{employeeId}
    </select>
    <insert id="insertViewRecord">
        insert into t_notice_view_record (notice_id, employee_id, first_ip, first_user_agent, page_view_count)
        values (#{noticeId}, #{employeeId}, #{ip}, #{userAgent}, #{pageViewCount})
    </insert>
    <update id="updateViewRecord">
        update t_notice_view_record
        set page_view_count = page_view_count + 1,
            last_ip         = #{ip},
            last_user_agent = #{userAgent}
        where notice_id = #{noticeId}
          and employee_id = #{employeeId}
    </update>
    <update id="updateViewCount">
        update t_notice
        set page_view_count = page_view_count + #{pageViewCountIncrement},
            user_view_count = user_view_count + #{userViewCountIncrement}
        where notice_id = #{noticeId}
    </update>

</mapper>